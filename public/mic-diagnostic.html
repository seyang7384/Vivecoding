<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í¬ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: system-ui;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }

        .meter {
            width: 100%;
            height: 30px;
            background: #333;
            margin: 10px 0;
            border-radius: 5px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #f59e0b, #ef4444);
            transition: width 0.1s;
        }

        button {
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
        }

        .start {
            background: #22c55e;
            color: white;
        }

        .stop {
            background: #ef4444;
            color: white;
        }

        select {
            padding: 10px;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }

        .status {
            padding: 20px;
            background: #333;
            border-radius: 8px;
            margin: 20px 0;
        }

        .good {
            color: #22c55e;
        }

        .bad {
            color: #ef4444;
        }
    </style>
</head>

<body>
    <h1>ğŸ¤ ë§ˆì´í¬ ì…ë ¥ í…ŒìŠ¤íŠ¸</h1>

    <div>
        <label>ë§ˆì´í¬ ì„ íƒ:</label>
        <select id="micSelect"></select>
    </div>

    <button class="start" onclick="startTest()">í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
    <button class="stop" onclick="stopTest()">ì¤‘ì§€</button>

    <div class="status">
        <h3>Left (ì¹˜ë£Œì‹¤)</h3>
        <div class="meter">
            <div id="meterL" class="meter-fill" style="width: 0%"></div>
        </div>
        <div id="rmsL">RMS: 0</div>
    </div>

    <div class="status">
        <h3>Right (ì›ì¥ë‹˜)</h3>
        <div class="meter">
            <div id="meterR" class="meter-fill" style="width: 0%"></div>
        </div>
        <div id="rmsR">RMS: 0</div>
    </div>

    <div class="status">
        <h3>ì§„ë‹¨:</h3>
        <div id="diagnosis">ë§ˆì´í¬ë¥¼ ì„ íƒí•˜ê³  í…ŒìŠ¤íŠ¸ ì‹œì‘ì„ ëˆ„ë¥´ì„¸ìš”</div>
    </div>

    <script>
        let audioContext, stream, processor, source;

        // List microphones
        navigator.mediaDevices.enumerateDevices().then(devices => {
            const audioInputs = devices.filter(d => d.kind === 'audioinput');
            const select = document.getElementById('micSelect');
            audioInputs.forEach((device, i) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                option.text = device.label || `ë§ˆì´í¬ ${i + 1}`;
                select.add(option);
            });
        });

        async function startTest() {
            const deviceId = document.getElementById('micSelect').value;

            stream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    channelCount: 2,
                    sampleRate: 16000,
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false
                }
            });

            audioContext = new AudioContext({ sampleRate: 16000 });
            source = audioContext.createMediaStreamSource(stream);
            processor = audioContext.createScriptProcessor(4096, 2, 2);

            processor.onaudioprocess = (e) => {
                const leftData = e.inputBuffer.getChannelData(0);
                const rightData = e.inputBuffer.getChannelData(1);

                const rmsL = Math.sqrt(leftData.reduce((sum, val) => sum + val * val, 0) / leftData.length);
                const rmsR = Math.sqrt(rightData.reduce((sum, val) => sum + val * val, 0) / rightData.length);

                // Update UI
                const percentL = Math.min(rmsL * 1000, 100);
                const percentR = Math.min(rmsR * 1000, 100);

                document.getElementById('meterL').style.width = percentL + '%';
                document.getElementById('meterR').style.width = percentR + '%';
                document.getElementById('rmsL').innerHTML = `RMS: ${rmsL.toFixed(4)} ${rmsL > 0.01 ? '<span class="good">âœ… ì¢‹ìŒ</span>' : '<span class="bad">âŒ ë„ˆë¬´ ë‚®ìŒ</span>'}`;
                document.getElementById('rmsR').innerHTML = `RMS: ${rmsR.toFixed(4)} ${rmsR > 0.01 ? '<span class="good">âœ… ì¢‹ìŒ</span>' : '<span class="bad">âŒ ë„ˆë¬´ ë‚®ìŒ</span>'}`;

                // Diagnosis
                let diag = '';
                if (rmsL < 0.001 && rmsR < 0.001) {
                    diag = 'âŒ <span class="bad">ì–‘ìª½ ë§ˆì´í¬ ëª¨ë‘ ì…ë ¥ ì—†ìŒ</span><br>â†’ ë¬´ì„  ë§ˆì´í¬ ì†¡ì‹ ê¸° 2ê°œê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”';
                } else if (rmsL < 0.001) {
                    diag = 'âš ï¸ Left ì±„ë„(ì¹˜ë£Œì‹¤) ì…ë ¥ ì—†ìŒ<br>â†’ ì™¼ìª½ ì†¡ì‹ ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”';
                } else if (rmsR < 0.001) {
                    diag = 'âš ï¸ Right ì±„ë„(ì›ì¥ë‹˜) ì…ë ¥ ì—†ìŒ<br>â†’ ì˜¤ë¥¸ìª½ ì†¡ì‹ ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”';
                } else {
                    diag = 'âœ… <span class="good">ì–‘ìª½ ë§ˆì´í¬ ì •ìƒ ì‘ë™ ì¤‘!</span>';
                }
                document.getElementById('diagnosis').innerHTML = diag;
            };

            source.connect(processor);
            processor.connect(audioContext.destination);

            console.log('í…ŒìŠ¤íŠ¸ ì‹œì‘ë¨');
        }

        function stopTest() {
            if (processor) processor.disconnect();
            if (source) source.disconnect();
            if (stream) stream.getTracks().forEach(t => t.stop());
            if (audioContext) audioContext.close();

            document.getElementById('meterL').style.width = '0%';
            document.getElementById('meterR').style.width = '0%';
            document.getElementById('diagnosis').innerHTML = 'í…ŒìŠ¤íŠ¸ ì¤‘ì§€ë¨';
        }
    </script>
</body>

</html>